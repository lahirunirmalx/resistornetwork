<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Resistor network calculator with R-2R ladder DAC designer">
  
  <title>Resistor Calculator</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/resistorcal.svg">
  <link rel="apple-touch-icon" href="icons/resistorcal-180.png">
  
  <style>
    :root {
      --bg: #0f172a;
      --surface: rgba(30, 41, 59, 0.85);
      --surface-alt: rgba(51, 65, 85, 0.6);
      --accent: #38bdf8;
      --accent-glow: rgba(56, 189, 248, 0.25);
      --success: #4ade80;
      --gold: #fbbf24;
      --text: #f1f5f9;
      --text-dim: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
      --radius: 16px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      background-image: 
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(56, 189, 248, 0.15), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(74, 222, 128, 0.08), transparent);
      color: var(--text);
    }
    
    .app {
      height: 100%;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
    }
    
    /* Header */
    header {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    
    header svg {
      width: 36px;
      height: 36px;
      filter: drop-shadow(0 0 8px var(--accent-glow));
    }
    
    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    
    /* Tab Navigation */
    .tabs {
      display: flex;
      padding: 0 16px;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .tab {
      flex: 1;
      padding: 12px 8px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-dim);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .tab:active { opacity: 0.7; }
    
    /* Views */
    .view {
      display: none;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 16px 16px;
      -webkit-overflow-scrolling: touch;
    }
    
    .view::-webkit-scrollbar { display: none; }
    .view { scrollbar-width: none; }
    .view.active { display: block; }
    
    /* Collapsible sections */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .panel-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    
    .panel-title {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }
    
    .panel-toggle {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      transition: transform 0.2s;
    }
    
    .panel.collapsed .panel-toggle { transform: rotate(-90deg); }
    .panel.collapsed .panel-body { display: none; }
    
    .panel-body {
      padding: 0 16px 16px;
    }
    
    /* Resistor chips */
    .chip-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .chip {
      padding: 8px 12px;
      background: var(--surface-alt);
      border: 1px solid transparent;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .chip.selected {
      background: rgba(56, 189, 248, 0.15);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .chip:active { transform: scale(0.95); }
    
    /* Quick actions */
    .quick-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .quick-btn {
      flex: 1;
      padding: 10px;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .quick-btn:active { background: var(--accent-glow); }
    
    /* Input area */
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .input-group {
      flex: 1;
    }
    
    .input-group label {
      display: block;
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    input[type="number"], select {
      width: 100%;
      padding: 12px 14px;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    
    input[type="number"]:focus, select:focus {
      border-color: var(--accent);
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    
    .calc-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accent), #0ea5e9);
      border: none;
      border-radius: 12px;
      color: #0f172a;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px var(--accent-glow);
      transition: transform 0.1s;
    }
    
    .calc-btn:active { transform: scale(0.98); }
    
    /* Results */
    .results-area {
      min-height: 100px;
    }
    
    .no-results {
      text-align: center;
      padding: 24px 16px;
      color: var(--text-dim);
      font-size: 0.85rem;
    }
    
    .result-card {
      background: var(--surface-alt);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 3px solid var(--success);
    }
    
    .result-card.top {
      border-left-color: var(--gold);
      background: linear-gradient(135deg, var(--surface-alt), rgba(251, 191, 36, 0.08));
    }
    
    .result-rank {
      display: inline-block;
      background: var(--gold);
      color: #0f172a;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 6px;
    }
    
    .result-expr {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      word-break: break-word;
    }
    
    .result-info {
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    
    /* Color codes section */
    .codes-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    
    .codes-label {
      font-size: 0.65rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }
    
    .part-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
    }
    
    .part-value {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gold);
      min-width: 60px;
    }
    
    .bands {
      display: flex;
      gap: 3px;
    }
    
    .band {
      width: 14px;
      height: 20px;
      border-radius: 2px;
      border: 1px solid rgba(255,255,255,0.15);
    }
    
    .smd-label {
      font-size: 0.7rem;
      color: var(--text-dim);
      font-family: 'SF Mono', monospace;
    }
    
    /* Legend row */
    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.65rem;
      color: var(--text-dim);
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.15);
    }
    
    /* R-2R Ladder styles */
    .ladder-diagram {
      background: var(--surface-alt);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      overflow-x: auto;
    }
    
    .ladder-svg {
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }
    
    .ladder-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .ladder-stat {
      background: var(--surface-alt);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    
    .ladder-stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
    }
    
    .ladder-stat-label {
      font-size: 0.65rem;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-top: 4px;
    }
    
    .voltage-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    
    .voltage-table th {
      background: var(--surface-alt);
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      font-size: 0.65rem;
    }
    
    .voltage-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .voltage-table tr:last-child td {
      border-bottom: none;
    }
    
    .voltage-table .binary {
      font-family: 'SF Mono', monospace;
      color: var(--accent);
    }
    
    .voltage-table .voltage {
      font-weight: 600;
    }
    
    .voltage-bar {
      height: 6px;
      background: var(--surface-alt);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    
    .voltage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      border-radius: 3px;
    }
    
    /* Install banner */
    .install-banner {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 16px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      backdrop-filter: blur(12px);
      z-index: 100;
    }
    
    .install-banner.show { display: block; }
    
    .install-content {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .install-text {
      flex: 1;
      font-size: 0.85rem;
    }
    
    .install-text strong { display: block; margin-bottom: 2px; }
    .install-text span { color: var(--text-dim); font-size: 0.75rem; }
    
    .install-btns {
      display: flex;
      gap: 8px;
    }
    
    .install-btns button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
    }
    
    .btn-install {
      background: var(--accent);
      color: #0f172a;
    }
    
    .btn-dismiss {
      background: var(--surface-alt);
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <svg viewBox="0 0 128 128" fill="none">
        <circle cx="64" cy="64" r="54" fill="#1e3a5f"/>
        <g stroke="#38bdf8" stroke-width="5" fill="none" stroke-linecap="round">
          <line x1="20" y1="64" x2="32" y2="64"/>
          <polyline points="32,64 38,48 50,80 62,48 74,80 86,48 92,64"/>
          <line x1="92" y1="64" x2="108" y2="64"/>
        </g>
      </svg>
      <h1>Resistor Calculator</h1>
    </header>
    
    <!-- Tab Navigation -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('network')">Network</button>
      <button class="tab" onclick="switchTab('r2r')">R-2R Ladder</button>
    </div>
    
    <!-- Network Calculator View -->
    <div class="view active" id="networkView">
      <div class="panel" id="resistorPanel">
        <div class="panel-header" onclick="togglePanel('resistorPanel')">
          <span class="panel-title">Available Resistors</span>
          <span class="panel-toggle">▼</span>
        </div>
        <div class="panel-body">
          <div class="quick-row">
            <button class="quick-btn" onclick="selectAll()">All</button>
            <button class="quick-btn" onclick="selectNone()">None</button>
            <button class="quick-btn" onclick="selectE12()">E12</button>
            <button class="quick-btn" onclick="selectE24()">E24</button>
          </div>
          <div class="chip-grid" id="chipGrid"></div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-body" style="padding-top: 16px;">
          <div class="input-row">
            <div class="input-group">
              <label>Target (Ω)</label>
              <input type="number" id="targetInput" placeholder="1500" inputmode="decimal">
            </div>
            <div class="input-group" style="max-width: 100px;">
              <label>Tolerance</label>
              <select id="tolSelect">
                <option value="1">1%</option>
                <option value="2">2%</option>
                <option value="5" selected>5%</option>
                <option value="10">10%</option>
              </select>
            </div>
          </div>
          <button class="calc-btn" onclick="calculate()">Calculate</button>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header" onclick="togglePanel('resultsPanel')" id="resultsPanel">
          <span class="panel-title">Results</span>
          <span class="panel-toggle">▼</span>
        </div>
        <div class="panel-body">
          <div class="results-area" id="output">
            <div class="no-results">Enter target value and calculate</div>
          </div>
        </div>
      </div>
      
      <div class="panel collapsed" id="legendPanel">
        <div class="panel-header" onclick="togglePanel('legendPanel')">
          <span class="panel-title">Color Reference</span>
          <span class="panel-toggle">▼</span>
        </div>
        <div class="panel-body">
          <div class="legend-row" id="legend"></div>
        </div>
      </div>
    </div>
    
    <!-- R-2R Ladder View -->
    <div class="view" id="r2rView">
      <div class="panel">
        <div class="panel-body" style="padding-top: 16px;">
          <div class="input-row">
            <div class="input-group">
              <label>R Value (Ω)</label>
              <select id="rValueSelect"></select>
            </div>
            <div class="input-group" style="max-width: 100px;">
              <label>Bits</label>
              <select id="bitsSelect">
                <option value="2">2-bit</option>
                <option value="3">3-bit</option>
                <option value="4" selected>4-bit</option>
                <option value="5">5-bit</option>
                <option value="6">6-bit</option>
                <option value="8">8-bit</option>
              </select>
            </div>
          </div>
          <div class="input-row">
            <div class="input-group">
              <label>Vref (V)</label>
              <input type="number" id="vrefInput" value="5" step="0.1" inputmode="decimal">
            </div>
          </div>
          <button class="calc-btn" onclick="calculateR2R()">Generate Ladder</button>
        </div>
      </div>
      
      <div class="panel" id="ladderResultPanel" style="display:none;">
        <div class="panel-header">
          <span class="panel-title">R-2R Ladder DAC</span>
        </div>
        <div class="panel-body">
          <div class="ladder-info" id="ladderInfo"></div>
          <div class="ladder-diagram" id="ladderDiagram"></div>
        </div>
      </div>
      
      <div class="panel" id="ladderCodesPanel" style="display:none;">
        <div class="panel-header" onclick="togglePanel('ladderCodesPanel')">
          <span class="panel-title">Resistor Codes</span>
          <span class="panel-toggle">▼</span>
        </div>
        <div class="panel-body" id="ladderCodes"></div>
      </div>
      
      <div class="panel" id="voltageTablePanel" style="display:none;">
        <div class="panel-header" onclick="togglePanel('voltageTablePanel')">
          <span class="panel-title">Output Voltages</span>
          <span class="panel-toggle">▼</span>
        </div>
        <div class="panel-body">
          <div id="voltageTable"></div>
        </div>
      </div>
      
      <div class="panel collapsed">
        <div class="panel-header" onclick="togglePanel('r2rInfoPanel')" id="r2rInfoPanel">
          <span class="panel-title">How R-2R Works</span>
          <span class="panel-toggle">▼</span>
        </div>
        <div class="panel-body">
          <p style="font-size:0.8rem;color:var(--text-dim);line-height:1.6;">
            The R-2R ladder is a simple, accurate DAC design using only two resistor values: R and 2R. 
            Each bit contributes half the voltage of the previous bit, creating a binary-weighted output.
            <br><br>
            <strong style="color:var(--text)">Components needed:</strong><br>
            • <span style="color:var(--accent)">R resistors:</span> Used in the horizontal ladder rungs<br>
            • <span style="color:var(--success)">2R resistors:</span> Used for bit inputs and termination<br>
            <br>
            The output voltage = Vref × (digital value) / 2<sup>n</sup>
          </p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="install-banner" id="installBanner">
    <div class="install-content">
      <div class="install-text">
        <strong>Install App</strong>
        <span>Add to home screen for quick access</span>
      </div>
      <div class="install-btns">
        <button class="btn-dismiss" onclick="dismissInstall()">Later</button>
        <button class="btn-install" onclick="installApp()">Install</button>
      </div>
    </div>
  </div>

  <script>
    // Common resistor values
    const RESISTORS = [
      1, 1.2, 1.5, 1.8, 2.2, 2.7, 3.3, 3.9, 4.7, 5.6, 6.8, 8.2,
      10, 12, 15, 18, 22, 27, 33, 39, 47, 56, 68, 82,
      100, 120, 150, 180, 220, 270, 330, 390, 470, 560, 680, 820,
      1e3, 1.2e3, 1.5e3, 1.8e3, 2.2e3, 2.7e3, 3.3e3, 3.9e3, 4.7e3, 5.6e3, 6.8e3, 8.2e3,
      10e3, 12e3, 15e3, 18e3, 22e3, 27e3, 33e3, 39e3, 47e3, 56e3, 68e3, 82e3,
      100e3, 120e3, 150e3, 180e3, 220e3, 270e3, 330e3, 390e3, 470e3, 560e3, 680e3, 820e3,
      1e6, 2.2e6, 3.3e6, 4.7e6
    ];
    
    // Common R values for R-2R ladders (user can use any, 2R is calculated)
    const R2R_VALUES = [10, 100, 1e3, 2.2e3, 4.7e3, 10e3, 22e3, 47e3, 100e3];
    
    const E12 = [1.0, 1.2, 1.5, 1.8, 2.2, 2.7, 3.3, 3.9, 4.7, 5.6, 6.8, 8.2];
    const E24 = [1.0, 1.1, 1.2, 1.3, 1.5, 1.6, 1.8, 2.0, 2.2, 2.4, 2.7, 3.0, 3.3, 3.6, 3.9, 4.3, 4.7, 5.1, 5.6, 6.2, 6.8, 7.5, 8.2, 9.1];
    
    const COLORS = ["#000", "#8B4513", "#f00", "#FFA500", "#ff0", "#0f0", "#00f", "#8B00FF", "#808080", "#fff"];
    const NAMES = ["Black", "Brown", "Red", "Orange", "Yellow", "Green", "Blue", "Violet", "Grey", "White"];
    
    let selected = new Set(RESISTORS);
    
    // ===================== Utility Functions =====================
    
    function fmt(v) {
      if (v >= 1e6) return (v/1e6).toFixed(v%1e6 ? 1 : 0) + 'M';
      if (v >= 1e3) return (v/1e3).toFixed(v%1e3 ? 1 : 0) + 'K';
      return String(v);
    }
    
    function togglePanel(id) {
      document.getElementById(id).classList.toggle('collapsed');
    }
    
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      
      if (tab === 'network') {
        document.querySelector('.tab:first-child').classList.add('active');
        document.getElementById('networkView').classList.add('active');
      } else {
        document.querySelector('.tab:last-child').classList.add('active');
        document.getElementById('r2rView').classList.add('active');
      }
    }
    
    function band4(ohms) {
      if (ohms <= 0) return [];
      let e = Math.floor(Math.log10(ohms)) - 1;
      if (e < 0) e = 0; if (e > 9) e = 9;
      let s = Math.round(ohms / Math.pow(10, e));
      if (s >= 100) { s = Math.floor(s/10); e++; }
      if (s < 10) { s *= 10; e--; }
      if (e < 0) e = 0; if (e > 9) e = 9;
      return [COLORS[Math.floor(s/10)], COLORS[s%10], COLORS[e], '#FFD700'];
    }
    
    function smd(ohms) {
      if (ohms <= 0) return "—";
      if (ohms < 10) return Math.floor(ohms) + 'R' + (Math.round((ohms - Math.floor(ohms)) * 10) % 10);
      let e = Math.floor(Math.log10(ohms)) - 1;
      if (e < 0) e = 0;
      let s = Math.round(ohms / Math.pow(10, e));
      if (s >= 100) { s = Math.floor(s/10); e++; }
      if (s < 10) { s *= 10; e--; }
      return `${s}${Math.max(0, e)}`;
    }
    
    function renderBands(colors) {
      return colors.map(c => `<div class="band" style="background:${c}"></div>`).join('');
    }
    
    // ===================== Network Calculator =====================
    
    function buildChips() {
      const g = document.getElementById('chipGrid');
      g.innerHTML = RESISTORS.map(r => 
        `<div class="chip ${selected.has(r)?'selected':''}" onclick="toggle(${r},this)">${fmt(r)}</div>`
      ).join('');
    }
    
    function toggle(v, el) {
      selected.has(v) ? selected.delete(v) : selected.add(v);
      el.classList.toggle('selected');
    }
    
    function selectAll() { selected = new Set(RESISTORS); buildChips(); }
    function selectNone() { selected.clear(); buildChips(); }
    
    function selectE12() {
      selected.clear();
      for (let m = 1; m <= 1e6; m *= 10) E12.forEach(b => { if (RESISTORS.includes(b*m)) selected.add(b*m); });
      buildChips();
    }
    
    function selectE24() {
      selected.clear();
      for (let m = 1; m <= 1e6; m *= 10) E24.forEach(b => { const v = Math.round(b*m*10)/10; if (RESISTORS.includes(v)) selected.add(v); });
      buildChips();
    }
    
    function calculate() {
      const target = parseFloat(document.getElementById('targetInput').value);
      const tol = parseFloat(document.getElementById('tolSelect').value) / 100;
      const out = document.getElementById('output');
      
      if (isNaN(target) || target <= 0) {
        out.innerHTML = '<div class="no-results" style="color:#f87171">Enter a valid target</div>';
        return;
      }
      
      const avail = Array.from(selected);
      if (!avail.length) {
        out.innerHTML = '<div class="no-results" style="color:#f87171">Select resistors first</div>';
        return;
      }
      
      const MAX_N = 4, MAX_NET = 5000;
      const nets = Array.from({length: MAX_N+1}, () => []);
      
      avail.forEach(r => nets[1].push({ R: r, n: 1, expr: fmt(r), parts: [r] }));
      
      for (let n = 2; n <= MAX_N; n++) {
        for (let i = 1; i < n; i++) {
          const j = n - i;
          for (let a = 0; a < nets[i].length; a++) {
            const A = nets[i][a];
            const bStart = i === j ? a : 0;
            for (let b = bStart; b < nets[j].length; b++) {
              const B = nets[j][b];
              const parts = [...A.parts, ...B.parts];
              if (nets[n].length < MAX_NET)
                nets[n].push({ R: A.R + B.R, n: A.n + B.n, expr: `(${A.expr}+${B.expr})`, parts });
              if (A.R > 0 && B.R > 0 && nets[n].length < MAX_NET)
                nets[n].push({ R: 1/(1/A.R + 1/B.R), n: A.n + B.n, expr: `(${A.expr}∥${B.expr})`, parts });
            }
          }
        }
      }
      
      const results = [];
      for (let n = 1; n <= MAX_N; n++)
        nets[n].forEach(net => {
          const err = Math.abs(net.R - target) / target;
          if (err <= tol) results.push({ ...net, error: err * 100 });
        });
      
      results.sort((a, b) => a.error - b.error);
      
      if (!results.length) {
        out.innerHTML = '<div class="no-results">No combinations found</div>';
        return;
      }
      
      const uniq = parts => [...new Set(parts)].sort((a,b) => a - b);
      
      out.innerHTML = results.slice(0, 30).map((r, i) => {
        let codesHtml = '';
        if (i < 5) {
          codesHtml = `<div class="codes-section"><div class="codes-label">Resistor codes</div>` +
            uniq(r.parts).map(p => `
              <div class="part-row">
                <span class="part-value">${fmt(p)}Ω</span>
                <div class="bands">${renderBands(band4(p))}</div>
                <span class="smd-label">${smd(p)}</span>
              </div>
            `).join('') + '</div>';
        }
        return `
          <div class="result-card ${i < 5 ? 'top' : ''}">
            <div class="result-expr">${i < 5 ? `<span class="result-rank">#${i+1}</span>` : ''}${r.expr}</div>
            <div class="result-info">= ${r.R.toFixed(2)}Ω · ${r.n} resistor${r.n>1?'s':''} · ${r.error.toFixed(2)}% error</div>
            ${codesHtml}
          </div>
        `;
      }).join('');
    }
    
    function buildLegend() {
      document.getElementById('legend').innerHTML = 
        NAMES.map((n, i) => `<div class="legend-item"><div class="legend-dot" style="background:${COLORS[i]}"></div>${i}=${n}</div>`).join('') +
        '<div class="legend-item"><div class="legend-dot" style="background:#FFD700"></div>Gold=5%</div>' +
        '<div class="legend-item"><div class="legend-dot" style="background:#C0C0C0"></div>Silver=10%</div>';
    }
    
    // ===================== R-2R Ladder Calculator =====================
    
    function buildR2RSelect() {
      const sel = document.getElementById('rValueSelect');
      sel.innerHTML = R2R_VALUES.map(r => `<option value="${r}">${fmt(r)}Ω → 2R = ${fmt(r*2)}Ω</option>`).join('');
      // Default to 10K
      sel.value = '10000';
    }
    
    function calculateR2R() {
      const R = parseFloat(document.getElementById('rValueSelect').value);
      const bits = parseInt(document.getElementById('bitsSelect').value);
      const vref = parseFloat(document.getElementById('vrefInput').value) || 5;
      const R2 = R * 2;
      
      // Show result panels
      document.getElementById('ladderResultPanel').style.display = 'block';
      document.getElementById('ladderCodesPanel').style.display = 'block';
      document.getElementById('voltageTablePanel').style.display = 'block';
      
      // Calculate component count
      const rCount = bits - 1;  // R resistors in horizontal rungs
      const r2Count = bits + 1; // 2R resistors (one per bit + termination)
      const totalCount = rCount + r2Count;
      
      // Ladder info
      document.getElementById('ladderInfo').innerHTML = `
        <div class="ladder-stat">
          <div class="ladder-stat-value">${rCount}</div>
          <div class="ladder-stat-label">R (${fmt(R)}Ω)</div>
        </div>
        <div class="ladder-stat">
          <div class="ladder-stat-value">${r2Count}</div>
          <div class="ladder-stat-label">2R (${fmt(R2)}Ω)</div>
        </div>
        <div class="ladder-stat">
          <div class="ladder-stat-value">${totalCount}</div>
          <div class="ladder-stat-label">Total Resistors</div>
        </div>
        <div class="ladder-stat">
          <div class="ladder-stat-value">${(vref / Math.pow(2, bits) * 1000).toFixed(2)}mV</div>
          <div class="ladder-stat-label">LSB Step</div>
        </div>
      `;
      
      // Generate SVG ladder diagram
      const svgWidth = Math.max(280, bits * 50 + 80);
      const svgHeight = 120;
      let svg = `<svg class="ladder-svg" viewBox="0 0 ${svgWidth} ${svgHeight}" width="${svgWidth}" height="${svgHeight}">`;
      
      // Draw ladder
      const startX = 30;
      const bitWidth = 50;
      const topY = 30;
      const bottomY = 90;
      
      // Horizontal lines
      svg += `<line x1="${startX}" y1="${topY}" x2="${startX + bits * bitWidth}" y2="${topY}" stroke="#38bdf8" stroke-width="2"/>`;
      
      // Ground termination 2R
      svg += `<rect x="${startX - 20}" y="${topY - 8}" width="16" height="16" fill="none" stroke="#4ade80" stroke-width="2"/>`;
      svg += `<text x="${startX - 12}" y="${topY + 20}" fill="#94a3b8" font-size="8" text-anchor="middle">2R</text>`;
      svg += `<line x1="${startX - 4}" y1="${topY}" x2="${startX}" y2="${topY}" stroke="#38bdf8" stroke-width="2"/>`;
      svg += `<text x="${startX - 20}" y="${topY - 12}" fill="#94a3b8" font-size="8" text-anchor="middle">GND</text>`;
      
      for (let i = 0; i < bits; i++) {
        const x = startX + i * bitWidth;
        const nextX = x + bitWidth;
        
        // R resistor (horizontal, except last)
        if (i < bits - 1) {
          svg += `<rect x="${x + 15}" y="${topY - 6}" width="${bitWidth - 30}" height="12" fill="none" stroke="#38bdf8" stroke-width="2"/>`;
          svg += `<text x="${x + bitWidth/2}" y="${topY - 12}" fill="#94a3b8" font-size="8" text-anchor="middle">R</text>`;
        }
        
        // 2R resistor (vertical to bit input)
        svg += `<line x1="${nextX}" y1="${topY}" x2="${nextX}" y2="${topY + 15}" stroke="#4ade80" stroke-width="2"/>`;
        svg += `<rect x="${nextX - 6}" y="${topY + 15}" width="12" height="${bottomY - topY - 30}" fill="none" stroke="#4ade80" stroke-width="2"/>`;
        svg += `<text x="${nextX + 12}" y="${topY + 35}" fill="#4ade80" font-size="8">2R</text>`;
        svg += `<line x1="${nextX}" y1="${bottomY - 15}" x2="${nextX}" y2="${bottomY}" stroke="#4ade80" stroke-width="2"/>`;
        
        // Bit label
        svg += `<text x="${nextX}" y="${bottomY + 14}" fill="#fbbf24" font-size="10" text-anchor="middle" font-weight="600">B${bits - 1 - i}</text>`;
      }
      
      // Output arrow
      const outX = startX + bits * bitWidth;
      svg += `<line x1="${outX}" y1="${topY}" x2="${outX + 25}" y2="${topY}" stroke="#38bdf8" stroke-width="2"/>`;
      svg += `<polygon points="${outX + 25},${topY - 5} ${outX + 35},${topY} ${outX + 25},${topY + 5}" fill="#38bdf8"/>`;
      svg += `<text x="${outX + 38}" y="${topY + 4}" fill="#38bdf8" font-size="10" font-weight="600">Vout</text>`;
      
      svg += '</svg>';
      document.getElementById('ladderDiagram').innerHTML = svg;
      
      // Color codes
      document.getElementById('ladderCodes').innerHTML = `
        <div class="part-row">
          <span class="part-value" style="color:var(--accent)">${fmt(R)}Ω</span>
          <div class="bands">${renderBands(band4(R))}</div>
          <span class="smd-label">${smd(R)}</span>
          <span style="color:var(--text-dim);font-size:0.7rem;margin-left:auto">×${rCount}</span>
        </div>
        <div class="part-row">
          <span class="part-value" style="color:var(--success)">${fmt(R2)}Ω</span>
          <div class="bands">${renderBands(band4(R2))}</div>
          <span class="smd-label">${smd(R2)}</span>
          <span style="color:var(--text-dim);font-size:0.7rem;margin-left:auto">×${r2Count}</span>
        </div>
      `;
      
      // Voltage table (sample values)
      const maxVal = Math.pow(2, bits);
      const step = bits <= 4 ? 1 : Math.pow(2, bits - 4); // Show 16 rows max
      let tableHtml = `
        <table class="voltage-table">
          <thead>
            <tr>
              <th>Binary</th>
              <th>Dec</th>
              <th>Vout</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (let d = 0; d < maxVal; d += step) {
        const binary = d.toString(2).padStart(bits, '0');
        const voltage = (vref * d / maxVal);
        const pct = (d / (maxVal - 1)) * 100;
        tableHtml += `
          <tr>
            <td class="binary">${binary}</td>
            <td>${d}</td>
            <td>
              <span class="voltage">${voltage.toFixed(3)}V</span>
              <div class="voltage-bar"><div class="voltage-bar-fill" style="width:${pct}%"></div></div>
            </td>
          </tr>
        `;
      }
      
      tableHtml += '</tbody></table>';
      if (step > 1) {
        tableHtml += `<div style="text-align:center;color:var(--text-dim);font-size:0.7rem;margin-top:8px">Showing every ${step} values</div>`;
      }
      document.getElementById('voltageTable').innerHTML = tableHtml;
    }
    
    // ===================== PWA Install =====================
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      setTimeout(() => document.getElementById('installBanner').classList.add('show'), 2000);
    });
    
    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
          document.getElementById('installBanner').classList.remove('show');
        });
      }
    }
    
    function dismissInstall() { document.getElementById('installBanner').classList.remove('show'); }
    
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
    
    // ===================== Init =====================
    
    buildChips();
    buildLegend();
    buildR2RSelect();
  </script>
</body>
</html>
